---
title: Traffic Charts
template: main.hbt
class: traffic
---

<script type="text/javascript">
    $(function() {

        var $body = $('div#main')
          , allPathData = {};

        function dataToCsv(data) {
            var out = '';
            data.path.forEach(function(path) {
                out += path.DataAsOf + ',' + path.Speed + '\n';
            });
            return out;
        }

        $.getJSON('/paths', function(data) {
            var pathFetchers = {};
            _.each(data.pathIds, function(id) {
                pathFetchers[id] = function(localCallback) {
                    $.getJSON('/' + id, function(pathData) {
                        allPathData[id] = pathData;
                        localCallback();
                    });
                };
            });
            async.parallel(pathFetchers, function(error) {
                _.each(allPathData, function(data, id) {
                    var csv = dataToCsv(data)
                      , onePoint = data.path[0]
                      , elId = 'traffic-path-' + id;
                    $body.append('<div id="' + elId + '"></div>');
                    new Dygraph(document.getElementById(elId), csv, {
                        title: onePoint.linkName + ' (' + onePoint.Borough + ')'
                      , ylabel: 'Speed'
                      , xlabel: 'Time'
                      , width: 800
                    });
                });

            });
        });


    });
</script>